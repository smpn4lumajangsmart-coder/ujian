<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PENILAI ESAI SISWA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .scroll-hidden::-webkit-scrollbar {
            display: none;
        }
    </style>
    <!-- jsPDF and html2canvas CDN for PDF download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border-t-4 border-indigo-600">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-indigo-800">AI Penilai Esai</h1>
        </header>

        <!-- Loading Indicator & Message Box -->
        <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-message" class="text-gray-700 font-medium">Memuat...</span>
            </div>
        </div>
        
        <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 id="message-title" class="text-xl font-bold mb-3 text-red-600">Error</h3>
                <p id="message-content" class="text-gray-700"></p>
                <button onclick="document.getElementById('message-box').classList.add('hidden')" class="mt-5 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150">Tutup</button>
            </div>
        </div>

        <!-- 1. Halaman Awal (Start Screen) -->
        <div id="start-screen">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Selamat Datang</h2>
                <button onclick="showView('teacher')" class="text-indigo-600 py-1 px-3 text-sm rounded-lg border border-indigo-200 hover:bg-indigo-50 transition duration-150">
                    Mode Pengaturan Guru
                </button>
            </div>

            <form id="start-form" class="space-y-4">
                <div class="bg-indigo-50 p-4 rounded-lg shadow-inner">
                    <p class="font-semibold text-indigo-700 mb-2">Pilih Ujian Hari Ini</p>
                    <div class="flex gap-4">
                        <div class="w-1/2">
                            <label for="select-subject" class="block text-xs font-medium text-gray-600">Mata Pelajaran</label>
                            <select id="select-subject" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white" onchange="filterMaterials()">
                                <option value="" disabled selected>Pilih...</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label for="select-material" class="block text-xs font-medium text-gray-600">Materi</label>
                            <select id="select-material" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <option value="" disabled selected>Pilih Materi...</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="select-duration" class="block text-xs font-medium text-gray-600">Durasi Ujian (menit)</label>
                        <input type="number" id="select-duration" value="30" min="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="pt-2">
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                    <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="student-class" class="block text-sm font-medium text-gray-700">Kelas/NIM</label>
                    <input type="text" id="student-class" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md hover:shadow-lg">
                    Mulai Ujian
                </button>
            </form>
        </div>

        <!-- 2. Halaman Ujian (Quiz Screen) -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
                <h2 id="question-header" class="text-2xl font-bold text-gray-800">Soal <span id="current-q-num">1</span>/<span id="total-q-num">1</span></h2>
                <div class="text-lg font-medium text-red-600">Sisa Waktu: <span id="timer">00:00</span></div>
            </div>
            <p id="quiz-context" class="text-xs text-gray-500 mb-4"></p>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
                <p id="quiz-question" class="text-gray-700 font-medium"></p>
                <div id="ai-feedback-container" class="hidden mt-3 p-3 bg-green-100 rounded-lg border border-green-300">
                    <p class="font-bold text-green-700">Skor AI: <span id="ai-score" class="text-2xl">0</span></p>
                    <p class="text-sm text-green-600">Umpan Balik: <span id="ai-feedback"></span></p>
                </div>
            </div>

            <textarea id="student-answer" rows="8" placeholder="Tulis jawaban Anda di sini..." class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500"></textarea>

            <div class="mt-6 flex justify-between gap-4">
                <button id="next-question-btn" onclick="nextQuestion()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Koreksi & Lanjut <span class="text-lg ml-1">&rarr;</span>
                </button>
            </div>
        </div>

        <!-- 3. Halaman Hasil (Results Screen) -->
        <div id="results-screen" class="hidden">
            <h2 class="text-3xl font-bold text-indigo-800 mb-4 text-center">Hasil Ujian</h2>

            <!-- Summary Card -->
            <div id="summary-card" class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg mb-6">
                <p class="text-sm font-light">Mata Pelajaran: <span id="res-subject"></span></p>
                <p class="text-sm font-light">Materi: <span id="res-material"></span></p>
                <h3 class="text-4xl font-extrabold mt-3">Skor Rata-rata: <span id="avg-score">0</span></h3>
                <p class="mt-2 text-sm">Nama Siswa: <span id="res-name"></span> (<span id="res-class"></span>)</p>
            </div>

            <!-- Detail Results Table -->
            <div class="max-h-96 overflow-y-auto scroll-hidden border border-gray-200 rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8/12">Soal & Jawaban</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">Skor/Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Results rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex flex-col md:flex-row gap-4">
                <button onclick="downloadPDF()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-md hover:shadow-lg">
                    Unduh PDF Hasil Ujian
                </button>
                <button onclick="showView('start')" class="flex-1 bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md hover:shadow-lg">
                    Kembali ke Awal
                </button>
            </div>
            <p id="submission-status" class="mt-4 text-center text-sm font-medium text-gray-600"></p>
        </div>

        <!-- 4. Halaman Pengaturan Guru (Teacher Settings) -->
        <div id="teacher-screen" class="hidden">
            <h2 class="text-2xl font-bold text-indigo-800 mb-6 border-b pb-2">Pengaturan Guru</h2>

            <!-- PIN Protection -->
            <div id="pin-prompt" class="space-y-4">
                <p class="text-gray-600">Masukkan PIN Guru (Default: 1234):</p>
                <input type="password" id="teacher-pin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="checkPin()" class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition">Masuk</button>
                <button onclick="showView('start')" class="w-full text-indigo-600 py-2 text-sm hover:text-indigo-800 transition duration-150">Kembali</button>
            </div>

            <!-- Settings Form -->
            <div id="settings-content" class="hidden space-y-6">
                <!-- Tab Konfigurasi -->
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Konfigurasi Server</h3>
                    <div class="space-y-3 p-4 border rounded-lg bg-gray-50">
                        <label class="block">
                            <span class="text-gray-700 text-sm">Nama Guru (Tanda Tangan PDF)</span>
                            <input type="text" id="setting-teacher-name" class="mt-1 block w-full px-3 py-2 border rounded-lg">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">URL Google Sheet (Soal CSV)</span>
                            <input type="url" id="setting-sheet-url" placeholder="Contoh: docs.google.com/spreadsheets/d/e/..." class="mt-1 block w-full px-3 py-2 border rounded-lg">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">URL Google Apps Script (Kurir AI & Simpan Hasil)</span>
                            <input type="url" id="setting-script-url" placeholder="Contoh: script.google.com/macros/s/.../exec" class="mt-1 block w-full px-3 py-2 border rounded-lg">
                        </label>
                        <p class="text-xs text-red-600 font-semibold pt-1">
                            * Gemini API Key diatur langsung di kode Google Apps Script (backend) untuk keamanan.
                        </p>
                    </div>
                </div>

                <!-- Tab Pembuatan Soal Otomatis -->
                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Pembuatan Soal Otomatis (via Gemini)</h3>
                    <div class="space-y-3 p-4 border rounded-lg bg-yellow-50">
                        <p class="text-xs text-yellow-800 font-semibold">
                            * Soal yang dihasilkan akan **LANGSUNG tersimpan** di Google Sheet tab 'Soal' Anda.
                        </p>
                        <textarea id="ai-prompt-input" rows="3" placeholder="Contoh: Buatkan 3 soal esai, kunci jawaban, mata pelajaran 'Kimia' dan materi 'Stoikiometri'." class="w-full p-3 border rounded-lg shadow-inner"></textarea>
                        <button onclick="generateQuestions()" class="w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition duration-150 font-medium disabled:opacity-50" id="generate-q-btn">
                            Generate & Simpan Soal ke Sheet
                        </button>
                        <div id="ai-questions-output" class="hidden mt-3 p-3 bg-green-100 rounded-lg border border-green-300">
                             <p class="font-bold text-green-800">Soal Berhasil Disimpan!</p>
                             <p class="text-sm text-green-700">Soal baru telah ditambahkan ke Sheet 'Soal'. Silakan kembali ke menu awal untuk memuat ulang data ujian.</p>
                        </div>
                    </div>
                </div>

                <!-- Aksi Pengaturan -->
                <div class="pt-4 border-t mt-6">
                    <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md hover:shadow-lg">
                        Simpan Pengaturan
                    </button>
                    <button onclick="createConfigLink()" class="mt-3 w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 transition duration-150 text-sm">
                        Buat Link Konfigurasi
                    </button>
                    <p id="config-link-output" class="mt-2 p-2 text-center text-sm bg-gray-100 rounded-lg break-all hidden"></p>
                    <button onclick="showView('start'); fetchSubjectsAndMaterials();" class="mt-4 w-full text-indigo-600 py-2 text-sm hover:text-indigo-800 transition duration-150">
                        Keluar dari Pengaturan & Muat Ulang
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- KONSTANTA & VARIABEL GLOBAL ---
        const DEFAULT_PIN = "1234";
        
        let settings = {
            teacherName: "Nama Guru Anda",
            sheetURL: "https://docs.google.com/spreadsheets/d/1pr96NA50DQ4zGB7MM4MrF4fx8Scvi03v8FAfsaFGwE4/edit",
            scriptURL: "https://script.google.com/macros/s/AKfycbxLKA7EJcNfEPXXvxDCQncA2lAFzZcotLXsF00kau7GntzxE_eA_QX_fBYy8ZnWNViaSg/exec",
            pin: DEFAULT_PIN
        };

        let questionsRaw = []; // Menyimpan semua data soal dari Sheet
        let questions = [];    // Menyimpan soal yang sudah difilter untuk ujian saat ini
        let uniqueSubjects = [];
        let currentQuestionIndex = 0;
        let studentInfo = {};
        let results = [];
        let timerInterval;

        // --- UTILITY FUNCTIONS ---

        function showMessage(title, content, isError = true) {
            const box = document.getElementById('message-box');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').innerHTML = content;
            document.getElementById('message-title').classList.toggle('text-red-600', isError);
            document.getElementById('message-title').classList.toggle('text-green-600', !isError);
            box.classList.remove('hidden');
        }

        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-indicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        function loadSettings() {
            const storedSettings = localStorage.getItem('aiEssayGraderSettings');
            if (storedSettings) {
                const loaded = JSON.parse(storedSettings);
                delete loaded.apiKey;
                settings = {...settings, ...loaded};
            }

            document.getElementById('setting-teacher-name').value = settings.teacherName;
            document.getElementById('setting-sheet-url').value = settings.sheetURL;
            document.getElementById('setting-script-url').value = settings.scriptURL;

            const urlParams = new URLSearchParams(window.location.search);
            const sheetUrlParam = urlParams.get('sheet_url');
            const scriptUrlParam = urlParams.get('apps_script_url');

            if (sheetUrlParam || scriptUrlParam) {
                if (sheetUrlParam) {
                    settings.sheetURL = sheetUrlParam;
                    document.getElementById('setting-sheet-url').value = sheetUrlParam;
                }
                if (scriptUrlParam) {
                    settings.scriptURL = scriptUrlParam;
                    document.getElementById('setting-script-url').value = scriptUrlParam;
                }
                saveSettings(false);
                showMessage("Konfigurasi Diperbarui", "URL telah diisi otomatis dari tautan konfigurasi.", false);
            }
        }

        function saveSettings(showAlert = true) {
            settings.teacherName = document.getElementById('setting-teacher-name').value;
            settings.sheetURL = document.getElementById('setting-sheet-url').value;
            settings.scriptURL = document.getElementById('setting-script-url').value;
            
            localStorage.setItem('aiEssayGraderSettings', JSON.stringify(settings));
            if (showAlert) {
                showMessage("Berhasil", "Pengaturan telah disimpan.", false);
            }
        }

        function getSheetId(url) {
            try {
                const regex = /\/d\/(.+?)\//;
                const match = url.match(regex);
                return match ? match[1] : null;
            } catch (error) {
                return null;
            }
        }

        // --- CORE APPLICATION LOGIC (PEMBARUAN) ---

        /** Mengambil data soal dari Google Sheet dan memproses Mata Pelajaran/Materi */
        async function fetchSubjectsAndMaterials() {
            if (!settings.sheetURL) {
                return;
            }
            
            const sheetId = getSheetId(settings.sheetURL);
            if (!sheetId) return;

            // Construct the CSV export URL
            // Pastikan sheet 'Soal' diatur untuk publik/Anyone with the link
            const exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Soal`;

            showLoading("Mengambil data ujian...");
            try {
                const response = await fetch(exportUrl);
                const csvText = await response.text();
                
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) {
                    // Ini normal jika sheet baru. Jangan tampilkan error jika hanya 1 baris (header)
                    if (lines.length === 1) {
                         console.warn("Sheet 'Soal' hanya berisi header. Data soal kosong.");
                    } else {
                        showMessage("Error", "Sheet 'Soal' kosong atau tidak dapat diakses. Pastikan Sheet 'Soal' ada dan diatur untuk akses publik.");
                    }
                    questionsRaw = []; // Reset data
                    uniqueSubjects = [];
                    populateSubjectsDropdown();
                    return;
                }

                questionsRaw = [];
                uniqueSubjects = [];
                const subjectsMap = new Set();
                
                // Parser CSV: Asumsi kolom: Mata Pelajaran, Materi, Tipe Soal, Soal, Kunci Jawaban
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    // Regex untuk memparsing kolom yang mungkin mengandung koma di dalam tanda kutip
                    const columns = line.match(/(?:[^,"]|"(?:\\.|[^"])*")*/g).slice(0, 5); 
                    
                    if (columns.length >= 5) {
                        const subject = columns[0].trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                        const material = columns[1].trim().replace(/^"|"$/g, '').replace(/""/g, '"');

                        if (subject && material) {
                            questionsRaw.push({
                                subject: subject,
                                material: material,
                                type: columns[2].trim().replace(/^"|"$/g, '').replace(/""/g, '"'),
                                question: columns[3].trim().replace(/^"|"$/g, '').replace(/""/g, '"'),
                                keyAnswer: columns[4].trim().replace(/^"|"$/g, '').replace(/""/g, '"'),
                                studentAnswer: "",
                                score: 0,
                                feedback: ""
                            });
                            subjectsMap.add(subject);
                        }
                    }
                }

                uniqueSubjects = Array.from(subjectsMap);
                populateSubjectsDropdown();

            } catch (error) {
                console.error("Fetch Data Error:", error);
                showMessage("Error Koneksi", "Gagal menghubungkan ke Google Sheet. Pastikan URL benar dan akses publik (Anyone with the link).");
            } finally {
                hideLoading();
            }
        }
        
        /** Mengisi dropdown Mata Pelajaran */
        function populateSubjectsDropdown() {
            const subjectSelect = document.getElementById('select-subject');
            subjectSelect.innerHTML = '<option value="" disabled selected>Pilih...</option>';
            uniqueSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            // Reset material dropdown
            document.getElementById('select-material').innerHTML = '<option value="" disabled selected>Pilih Materi...</option>';
        }

        /** Memfilter dan mengisi dropdown Materi berdasarkan Mata Pelajaran yang dipilih */
        function filterMaterials() {
            const selectedSubject = document.getElementById('select-subject').value;
            const materialSelect = document.getElementById('select-material');
            materialSelect.innerHTML = '<option value="" disabled selected>Pilih Materi...</option>';

            if (selectedSubject) {
                const uniqueMaterials = new Set();
                questionsRaw.forEach(q => {
                    if (q.subject === selectedSubject) {
                        uniqueMaterials.add(q.material);
                    }
                });
                
                Array.from(uniqueMaterials).forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    option.textContent = material;
                    materialSelect.appendChild(option);
                });
            }
        }

        /** Memulai Timer Ujian */
        function startTimer(durationInMinutes) {
            clearInterval(timerInterval);
            const durationInSeconds = durationInMinutes * 60;
            let timeRemaining = durationInSeconds;
            
            const timerElement = document.getElementById('timer');
            
            const updateTimer = () => {
                const minutes = String(Math.floor(timeRemaining / 60)).padStart(2, '0');
                const seconds = String(timeRemaining % 60).padStart(2, '0');
                timerElement.textContent = `${minutes}:${seconds}`;

                if (timeRemaining <= 60) {
                    timerElement.classList.add('text-red-800', 'font-extrabold');
                } else {
                    timerElement.classList.remove('text-red-800', 'font-extrabold');
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    showMessage("Waktu Habis", "Waktu ujian Anda telah habis. Hasil akan diproses.");
                    finishQuiz();
                } else {
                    timeRemaining--;
                }
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        /** Pindah ke Soal berikutnya atau Selesaikan Kuis */
        async function nextQuestion() {
            const answer = document.getElementById('student-answer').value.trim();
            if (!answer) {
                showMessage("Perhatian", "Anda harus mengisi jawaban sebelum melanjutkan.");
                return;
            }

            questions[currentQuestionIndex].studentAnswer = answer;
            document.getElementById('next-question-btn').disabled = true;
            
            await gradeAnswer(currentQuestionIndex);
            
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                clearInterval(timerInterval);
                finishQuiz();
            }
        }

        /** Menampilkan Soal ke UI */
        function displayQuestion() {
            const q = questions[currentQuestionIndex];
            
            document.getElementById('current-q-num').textContent = currentQuestionIndex + 1;
            document.getElementById('total-q-num').textContent = questions.length;
            document.getElementById('quiz-question').textContent = q.question;
            document.getElementById('quiz-context').textContent = `${q.subject} > ${q.material} (Tipe: ${q.type})`;
            document.getElementById('student-answer').value = q.studentAnswer;
            
            document.getElementById('ai-feedback-container').classList.add('hidden');
            document.getElementById('next-question-btn').disabled = false;
        }

        /** Koreksi Jawaban Siswa melalui Apps Script Proxy */
        async function gradeAnswer(index) {
            const q = questions[index];
            if (!settings.scriptURL) {
                showMessage("Error", "URL Apps Script belum diatur. Koreksi AI dibatalkan.");
                return;
            }
            
            const payload = {
                action: 'proxy_gemini',
                actionType: 'grade',
                question: q.question,
                keyAnswer: q.keyAnswer,
                studentAnswer: q.studentAnswer
            };
            
            showLoading(`Mengoreksi Soal ${index + 1}/${questions.length} dengan AI...`);
            
            try {
                const fullResponse = await fetch(settings.scriptURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await fullResponse.json();

                if (data.status === 'success' && data.result) {
                    const result = data.result;
                    q.score = result.score || 0;
                    q.feedback = result.feedback || "Tidak ada umpan balik dari AI.";
                    
                    document.getElementById('ai-score').textContent = q.score;
                    document.getElementById('ai-feedback').textContent = q.feedback;
                    document.getElementById('ai-feedback-container').classList.remove('hidden');

                } else if (data.status === 'error') {
                     throw new Error(data.message || "Kesalahan Apps Script: Gagal mengoreksi jawaban.");
                } else {
                    throw new Error("Respons Apps Script tidak valid atau kosong.");
                }

            } catch (error) {
                console.error("Koreksi AI Error:", error);
                q.score = 0;
                q.feedback = `Koreksi gagal: ${error.message}. Cek URL Apps Script dan API Key di backend.`;
                showMessage("Error Koreksi AI", `Koreksi AI untuk Soal ${index + 1} gagal: ${error.message}.`);
            } finally {
                hideLoading();
            }
        }

        /** Menyelesaikan Kuis dan Menampilkan Hasil */
        function finishQuiz() {
            let totalScore = 0;
            questions.forEach(q => totalScore += q.score);
            const averageScore = questions.length > 0 ? Math.round(totalScore / questions.length) : 0;
            
            results = questions;
            
            // Perbarui UI Hasil
            document.getElementById('res-name').textContent = studentInfo.name;
            document.getElementById('res-class').textContent = studentInfo.class;
            document.getElementById('res-subject').textContent = studentInfo.subject;
            document.getElementById('res-material').textContent = studentInfo.material;
            document.getElementById('avg-score').textContent = averageScore;
            
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            
            results.forEach((q, index) => {
                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-3 py-4 align-top text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 align-top">
                            <p class="font-semibold text-gray-800">Soal:</p>
                            <p class="text-sm text-gray-600 mb-2">${q.question}</p>
                            <p class="font-semibold text-indigo-600">Jawaban Anda:</p>
                            <p class="text-xs text-gray-700 whitespace-pre-wrap">${q.studentAnswer}</p>
                        </td>
                        <td class="px-6 py-4 align-top">
                            <p class="font-extrabold text-xl text-green-700">${q.score}</p>
                            <p class="text-xs font-semibold mt-2 text-gray-700">Feedback AI:</p>
                            <p class="text-xs text-gray-500">${q.feedback}</p>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
            
            showView('results');
            submitResultsToAppsScript(averageScore);
        }
        
        /** Mengirim hasil ke Google Apps Script */
        async function submitResultsToAppsScript(averageScore) {
            const statusElement = document.getElementById('submission-status');
            if (!settings.scriptURL) {
                statusElement.textContent = "URL Apps Script belum diatur. Hasil tidak disimpan ke server.";
                statusElement.classList.remove('text-gray-600', 'text-green-600');
                statusElement.classList.add('text-red-600');
                return;
            }

            statusElement.textContent = "Mengirim hasil ke server...";
            statusElement.classList.add('text-indigo-600');
            statusElement.classList.remove('text-red-600', 'text-green-600');

            const payload = {
                action: 'save_results', // Action differentiator for Apps Script
                studentName: studentInfo.name,
                studentClass: studentInfo.class,
                subject: studentInfo.subject, // Now part of studentInfo
                material: studentInfo.material, // Now part of studentInfo
                averageScore: averageScore,
                details: results.map(q => ({
                    question: q.question,
                    studentAnswer: q.studentAnswer,
                    score: q.score,
                    feedback: q.feedback,
                    subject: q.subject, // Detail for individual submission
                    material: q.material,
                    type: q.type
                }))
            };

            try {
                // Using mode: 'no-cors' for the save operation due to Apps Script Web App constraints
                const response = await fetch(settings.scriptURL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                statusElement.textContent = "Hasil berhasil dikirimkan ke server Apps Script.";
                statusElement.classList.add('text-green-600');
                statusElement.classList.remove('text-indigo-600');

            } catch (error) {
                console.error("Apps Script Submission Error:", error);
                statusElement.textContent = "Gagal mengirim hasil ke server Apps Script. Cek URL dan koneksi Anda.";
                statusElement.classList.add('text-red-600');
                statusElement.classList.remove('text-indigo-600');
            }
        }


        // --- UI & View Management ---

        function showView(viewName) {
            ['start-screen', 'quiz-screen', 'results-screen', 'teacher-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(`${viewName}-screen`).classList.remove('hidden');
            
            if (viewName !== 'quiz') {
                clearInterval(timerInterval);
            }
        }

        /** Handler Form Start */
        document.getElementById('start-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedSubject = document.getElementById('select-subject').value;
            const selectedMaterial = document.getElementById('select-material').value;
            const duration = parseInt(document.getElementById('select-duration').value);

            if (!selectedSubject || !selectedMaterial || !questionsRaw.length) {
                showMessage("Error", "Pilihan ujian atau data soal tidak valid. Pastikan data sudah dimuat dan pilihan sudah lengkap.");
                return;
            }
            
            if (!settings.scriptURL) {
                showMessage("Error", "URL Google Apps Script (Kurir AI) belum diatur. Silakan masuk ke Mode Guru.");
                return;
            }
            
            // Filter questions based on selection
            questions = questionsRaw.filter(q => q.subject === selectedSubject && q.material === selectedMaterial);
            
            if (questions.length === 0) {
                 showMessage("Error", "Tidak ada soal yang ditemukan untuk kombinasi Mata Pelajaran dan Materi yang dipilih.");
                return;
            }

            // Simpan info ujian yang dipilih ke studentInfo
            studentInfo.name = document.getElementById('student-name').value.trim();
            studentInfo.class = document.getElementById('student-class').value.trim();
            studentInfo.subject = selectedSubject;
            studentInfo.material = selectedMaterial;
            
            currentQuestionIndex = 0;
            results = [];
            displayQuestion();
            startTimer(duration);
            showView('quiz');
        });

        // --- Teacher Mode Logic ---

        function checkPin() {
            const pinInput = document.getElementById('teacher-pin').value;
            if (pinInput === settings.pin) {
                document.getElementById('pin-prompt').classList.add('hidden');
                document.getElementById('settings-content').classList.remove('hidden');
                // Sembunyikan pesan sukses/gagal generate sebelumnya
                document.getElementById('ai-questions-output').classList.add('hidden'); 
            } else {
                showMessage("Akses Ditolak", "PIN salah. Silakan coba lagi.");
            }
        }

        /** Generate & SIMPAN Soal Otomatis melalui Apps Script Proxy */
        async function generateQuestions() {
            const prompt = document.getElementById('ai-prompt-input').value.trim();
            document.getElementById('ai-questions-output').classList.add('hidden');
            
            if (!settings.scriptURL) {
                showMessage("Error", "URL Apps Script belum diatur. Tidak dapat menghasilkan soal.");
                return;
            }
            if (!prompt) {
                showMessage("Perhatian", "Silakan masukkan prompt pembuatan soal.");
                return;
            }

            const payload = {
                action: 'proxy_gemini',
                actionType: 'generate_and_save', // Aksi baru: Generate dan Langsung Simpan
                prompt: prompt
            };

            showLoading("Menghasilkan dan menyimpan soal ke Google Sheet...");
            document.getElementById('generate-q-btn').disabled = true;

            try {
                const response = await fetch(settings.scriptURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.status === 'success' && data.message) {
                    document.getElementById('ai-questions-output').classList.remove('hidden');
                    showMessage("Berhasil", data.message, false);
                    
                    // Muat ulang data Sheet agar dropdown terupdate
                    await fetchSubjectsAndMaterials(); 
                    
                } else if (data.status === 'error') {
                    throw new Error(data.message || "Kesalahan Apps Script: Gagal membuat soal.");
                } else {
                    throw new Error("Respons Apps Script tidak valid atau kosong.");
                }

            } catch (error) {
                console.error("Generate Questions Error:", error);
                document.getElementById('ai-questions-output').classList.add('hidden');
                showMessage("Error AI/Simpan", `Gagal membuat dan menyimpan soal: ${error.message}`);
            } finally {
                hideLoading();
                document.getElementById('generate-q-btn').disabled = false;
            }
        }
        
        /** Membuat Link Konfigurasi */
        function createConfigLink() {
            const sheetUrl = document.getElementById('setting-sheet-url').value;
            const scriptUrl = document.getElementById('setting-script-url').value;

            if (!sheetUrl || !scriptUrl) {
                showMessage("Perhatian", "Anda harus mengisi URL Google Sheet dan Apps Script terlebih dahulu.");
                return;
            }

            const currentBaseUrl = window.location.origin + window.location.pathname;
            const configLink = `${currentBaseUrl}?sheet_url=${encodeURIComponent(sheetUrl)}&apps_script_url=${encodeURIComponent(scriptUrl)}`;

            const outputElement = document.getElementById('config-link-output');
            outputElement.textContent = configLink;
            outputElement.classList.remove('hidden');
            
            // Copy to clipboard
            navigator.clipboard.writeText(configLink).then(() => {
                showMessage("Berhasil", "Link konfigurasi berhasil dibuat dan disalin ke clipboard!", false);
            }).catch(err => {
                showMessage("Perhatian", "Gagal menyalin link ke clipboard. Salin secara manual.");
            });
        }

        // --- PDF Download Logic (Unchanged) ---
        function downloadPDF() {
            const originalContent = document.getElementById('app-container').innerHTML;
            const resultElement = document.getElementById('results-screen');
            const fileName = `Hasil_Esai_${studentInfo.name.replace(/\s/g, '_')}_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.pdf`;

            const pdfContainer = document.createElement('div');
            pdfContainer.className = 'p-6 bg-white';
            pdfContainer.style.width = '210mm'; 
            pdfContainer.style.margin = '0 auto'; 

            pdfContainer.innerHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-extrabold text-indigo-800">LAPORAN HASIL UJIAN ESAI AI</h1>
                    <p class="text-sm text-gray-600 mt-1">${studentInfo.subject} - ${studentInfo.material}</p>
                    <p class="text-xs text-gray-500">Tanggal Ujian: ${new Date().toLocaleDateString('id-ID')}</p>
                </div>
                ${document.getElementById('summary-card').outerHTML}
                <h2 class="text-lg font-bold text-gray-800 mt-6 mb-3 border-b pb-1">Detail Koreksi Soal</h2>
            `;
            
            const detailTable = document.createElement('div');
            detailTable.innerHTML = document.getElementById('results-table-body').parentElement.outerHTML;
            const thead = detailTable.querySelector('thead');
            if (thead) thead.classList.remove('sticky', 'top-0');

            pdfContainer.appendChild(detailTable);

            pdfContainer.innerHTML += `
                <div class="mt-12 text-right text-sm">
                    <p>Hormat kami,</p>
                    <p class="mt-16 font-semibold">${settings.teacherName}</p>
                    <p class="text-xs text-gray-500">Guru Mata Pelajaran</p>
                </div>
            `;

            document.getElementById('app-container').classList.add('hidden');
            document.body.appendChild(pdfContainer);
            showLoading("Membuat dokumen PDF...");

            html2canvas(pdfContainer, { scale: 2, logging: false }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                const pdf = new jsPDF('p', 'mm', 'a4');
                let position = 10;
                
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(fileName);

                document.body.removeChild(pdfContainer);
                document.getElementById('app-container').classList.remove('hidden');
                hideLoading();
            }).catch(error => {
                console.error("PDF Generation Error:", error);
                document.body.removeChild(pdfContainer);
                document.getElementById('app-container').classList.remove('hidden');
                hideLoading();
                showMessage("Error PDF", "Gagal membuat dokumen PDF.");
            });
        }
        
        // --- INIT ---
        window.onload = () => {
            loadSettings();
            fetchSubjectsAndMaterials(); // Load initial data
            showView('start');
        };
    </script>
</body>
</html>